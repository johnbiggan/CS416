<!DOCTYPE html>
<meta charset="utf-8">
<link href="style.css" rel="stylesheet" />

<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>

<head><title>US Presidential Vote</title>

<h1 align="center">US Presidential Vote</h1>
<h2 id="subtitle" align="center"></h2>

<button onclick="update(0)">1976</button>
<button onclick="update(1)">1980</button>
<button onclick="update(2)">1992</button>
<button onclick="update(3)">2000</button>
<button onclick="update(4)">2008</button>
<button onclick="update(5)">2016</button>
<button onclick="update(6)">2020</button>

</head>

<div id="container">
    <div class="states_viz"></div>
    <div class="line_viz"></div>
</div>

<div id="desc_viz"></div>

<script>

var yr_data = [
    //1972,
    1976,1980,1992,2000,2008,2016,2020
];

var yr_rg_data = [
    '1976','1976-1980','1976-1992','1976-2000','1976-2008','1976-2016','1976-2020'
];

var desc_data = [
    //'In 1972, Richard Nixon (R) defeated George McGovern (D) in one of the largest electoral wins in history by winning 49 states, losing only Massachusettes and the District of Columbia.',
    'Following the Watergate Scandal, Democratic Presidential candidate Jimmy Carter defeated Gerald Ford (R). The native Georgian carried the South and Northeast.',
    'Ronald Reagan (D) won a landslide victory against incumbent Jimmy Carter (D). His victory was aided by economic stagflation and the Iran Hostage Crisis.',
    'Following 12 years of Republican Presidents, Bill Clinton (D) defeated the supposedley undefeatable incumbent George H.W. Bush. An economic downturn and rising crime rate, along with the strong showing by third-party challenger Ross Perot (I) played a significant role in this upset.',
    'At the turn of the millenium, Texas Governor George W. Bush (R) won the electoral college while losing the popular vote. Al Gore (D) pushed for a recount, but the Supreme Court interceded and declared Bush the winner.',
    'Heading into the The Great Recession, Barack Obama (D) became the first African American elected to the Presidency. Discontent with the War in Iraq and along with the economic woes were some of the primary driving forces helping the Democratic candidate.',
    'In one of the biggest upset in recent history, Hillary Clinton (D) was defeated by Donald Trump (R), though she won the popular vote. Virtually all polls had Clinton winning handily.',
    'In the midst of COVID-19 and social unrest, former Vice President Joe Biden (D) was elected President.'
];

var margin = {top: 10, right: 30, bottom: 30, left: 60},
    width = 700 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;
    
var st_svg = d3.select(".states_viz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");
    
var ln_svg = d3.select(".line_viz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

// Set the ranges
var x = d3.scaleLinear().range([0, width]).domain([d3.min(yr_data),d3.max(yr_data)]);
var y = d3.scaleLinear().range([height, 0]).domain([0,90000000]);

// Define the axes
var x_axis = d3.axisBottom().scale(x).ticks(12).tickFormat(d3.format("d"));
ln_svg.append("g")
.attr("transform", "translate(0," + height + ")")
.call(x_axis);
    
var y_axis = d3.axisLeft().scale(y).ticks(5);//.tickFormat(d3.format(".0%"));
ln_svg.append("g")
.call(y_axis);

// Define the line
//var vote_line = d3.svg.line()
//    .x(function(d) { return x(d.year); })
//    .y(function(d) { return y(d.vote_perc); });

var party_scale = d3.scaleOrdinal()
    .domain(["DEMOCRAT", "REPUBLICAN", "LIBERTARIAN", "OTHER"])
    .range(["blue", "red", "yellow", "grey"]);

function update(ind) {

    d3.select("#desc_viz")
        .text(desc_data[ind]);
    d3.select("#subtitle")
        .text(yr_rg_data[ind]);

    d3.csv("1976-2020-president.csv", function(data) {
        // group the data: I want to draw one line per group
        var sumstat = d3.nest() // nest function allows to group the calculation per level of a factor
        .key(function(d) { return d.party_simplified;})
        .key(function(d) { return d.year;})
        .rollup(function(leaves){
            return d3.sum(leaves, function(c){
                return c.candidatevotes;
            })
        })
        .entries(data);
        console.log(sumstat);
        console.log(sumstat.filter(function(d){return d.key=="DEMOCRAT";}));
        console.log(sumstat.filter(function(d){return +d.values.key<=yr_data[ind]}));
        console.log("Test7");
        console.log(yr_data[ind]);

        // Draw the line
        //ln_svg.selectAll(".line")
        //.data(sumstat)
        //.enter()
        //.append("g")
        //.attr("fill", "none")
        //.attr("stroke", function(d){ return party_scale(d.key) })
        //.attr("stroke-width", 1.5)
        //.attr("d", function(d){
        //  return d3.line()
        //    .x(function(d) { return x(d.year); })
        //    .y(function(d) { return y(d.percentvotes); })
        //    (d.values)
        //})
        
        ln_svg.selectAll(".line")
        .append("g")
        //.attr("transform", "translate(0," + height + ")")
        .attr("class", "line")
        //.data(sumstat.filter(function(d){return d.values.key<=ind}))
        .data(sumstat)
        .enter()
        .append("path")
        .attr("d", function (d) {
            return d3.line()
                .x(d => x(d.key))
                .y(d => y(d.value))
                (d.values)
        })
        .attr("fill", "none")
        .attr("stroke", d => party_scale(d.key))
        .attr("stroke-width", 2)
        .transition()
        .duration(2000)
    })
}

update(0)
  
</script>
